# Worker実行時間とDiscord APIレート制限の詳細

## Cloudflare Workers実行時間

### CPU時間 vs Wall時間の違い
- **CPU時間**: 実際の計算処理時間のみ
- **Wall時間**: 実際の経過時間（最大15秒）
- **重要**: API待機時間はCPU時間にカウントされない！

### 無料プランでの制限
- CPU時間: 10ms/リクエスト
- Wall時間: 15秒/リクエスト
- 日次リクエスト: 10万件

## Discord APIレート制限詳細

### グローバル制限
- **全体**: 50リクエスト/秒
- **無効なリクエスト**: 10,000/10分（401, 403, 429エラー）

### 特定エンドポイントの制限
- **チャンネルメッセージ**: 5メッセージ/5秒/チャンネル
- **DM作成**: 5 DM/5秒（グローバル）
- **Webhook**: 5リクエスト/2秒/webhook（グローバル制限の対象外）

### レート制限ヘッダー
```
X-RateLimit-Limit: 制限値
X-RateLimit-Remaining: 残りリクエスト数
X-RateLimit-Reset: リセット時刻（Unix timestamp）
X-RateLimit-Reset-After: リセットまでの秒数
X-RateLimit-Bucket: バケット識別子
```

## 実装への影響

### 1回のWorker実行での処理能力

**理論上の最大値**（15秒のWall時間内）:
- グローバル制限: 750リクエスト（50/秒 × 15秒）
- DM送信: 15 DM（5 DM/5秒 × 3回）
- チャンネルメッセージ: 15メッセージ/チャンネル

**実際の推奨値**:
- 安全マージン80%で運用
- 40リクエスト/秒を目安に
- バッチ処理で効率化

### 最適なバッチ設定

```typescript
// 積極的な設定（大規模向け）
const batchSize = 10;  // 10並列処理
const batchDelay = 200;  // 200ms遅延

// 1分間での処理能力:
// 10並列 × 300バッチ/分 = 3,000処理/分
// ただしDM制限により実際は60 DM/分が上限
```

### エラーハンドリング

429エラー時の対応:
1. `Retry-After`ヘッダーの値だけ待機
2. 指数バックオフで再試行
3. バケットごとに管理

## 推奨アーキテクチャ

### 現在の実装の利点
- Worker内で完結（外部キュー不要）
- API待機時間がCPU時間を消費しない
- 15秒あれば数百の通知を処理可能

### スケール時の考慮事項
1. **1,000件以下**: 現在の実装で十分
2. **1,000-10,000件**: バッチサイズを調整
3. **10,000件以上**: 複数Worker実行やキューシステムを検討

## まとめ

- **CPU時間の心配は不要**: API待機はカウントされない
- **主な制約はDiscord API**: 特にDM作成の5/5秒制限
- **現在の設定は控えめ**: もっと積極的に並列化可能
- **15秒で十分**: 数百件の通知なら1回の実行で処理可能