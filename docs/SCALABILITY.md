# スケーラビリティ分析

Discord 調整ちゃんの現在の設計における、Cloudflare の無料プランと有料プランでのスケーラビリティ分析。

## 前提条件

### 典型的なユーザー行動パターン
- 新規スケジュール作成: 1回/user/日
- 投票操作: 2-3回/user/日 (参加・変更・コメント)
- 閲覧: 5-10回/user/日 (読み取り専用)

### KV操作の内訳
- スケジュール作成: 2-3回のKV書き込み
- 投票操作: 1-2回のKV書き込み
- 閲覧: 1-2回のKV読み取り

## Cloudflare 無料プラン

### 制限事項
- **KV書き込み**: 1,000回/日
- **KV読み取り**: 100,000回/日
- **Worker実行**: 100,000回/日
- **メモリ**: 128MB
- **CPU時間**: 10ms/実行

### 推定容量

#### 日次容量
- **アクティブユーザー数**: 200-300人/日
- **新規スケジュール**: 100-150個/日
- **投票操作**: 300-500回/日
- **閲覧操作**: 1,000-2,000回/日

#### 制限要因
**KV書き込み制限**が最大のボトルネック
- スケジュール作成: 150個 × 3回 = 450回
- 投票操作: 500回 × 2回 = 1,000回
- **合計**: 1,450回/日 → **制限を超過**

### 実際の運用可能範囲
- **安全マージン考慮**: 800回/日（制限の80%）
- **推定アクティブユーザー**: 200-250人/日
- **推定新規スケジュール**: 100個/日
- **推定投票操作**: 300-400回/日

## Cloudflare 有料プラン ($5/月)

### 制限事項
- **KV書き込み**: 無制限
- **KV読み取り**: 無制限
- **Worker実行**: 無制限
- **メモリ**: 128MB
- **CPU時間**: 50ms/実行
- **KVストレージ**: 1GB

### 推定容量

#### 日次容量
- **アクティブユーザー数**: 10,000-15,000人/日
- **新規スケジュール**: 5,000-8,000個/日
- **投票操作**: 20,000-50,000回/日
- **閲覧操作**: 50,000-100,000回/日

#### 制限要因

1. **Discord API制限**
   - Webhook制限: 30リクエスト/分
   - 通知バッチ処理で対応済み

2. **KVストレージ容量 (1GB)**
   - スケジュール1個あたり: 約2-5KB
   - 推定保存可能数: 200,000-500,000個
   - **自動削除（TTL）により解決済み**

3. **CPU時間制限 (50ms)**
   - 複雑な集計処理で制限に達する可能性
   - 最適化済みでほぼ問題なし

### 長期運用でのストレージ試算

#### 自動削除機能による容量制御
- **データ保持期間**: 6ヶ月（締切日から）
- **最大保存データ**: 6ヶ月分のみ
- **実際の使用容量**: 常に一定範囲内

#### 理論上の最大容量（6ヶ月分）
- **新規スケジュール**: 1,000,000個/6ヶ月
- **平均サイズ**: 3KB/個
- **必要容量**: 約3GB/6ヶ月

**実際の運用**: KVの自動削除（TTL）機能により、古いデータは自動的に削除されるため、**容量制限は事実上解決済み**

## 対処方法

### 短期対応
1. **古いデータの自動削除**
   - 3ヶ月以上前のクローズ済みスケジュール削除
   - 定期的なクリーンアップジョブ

2. **データ圧縮**
   - JSON圧縮
   - 不要フィールドの削除

### 中期対応
1. **外部ストレージ連携**
   - Cloudflare R2 (Object Storage)
   - 古いデータのアーカイブ

2. **データベース移行**
   - Cloudflare D1 (SQLite)
   - より効率的なデータ構造

### 長期対応
1. **アーキテクチャ見直し**
   - マイクロサービス化
   - 専用データベース利用

2. **有料プラン上位移行**
   - Workers Paid ($5/月 → $30/月)
   - 追加リソース確保

## 実際の運用での注意点

### 無料プランでの運用
- **監視必須**: KV書き込み回数の日次監視
- **制限対策**: ピーク時の書き込み制限
- **緊急停止**: 制限超過時の自動停止機能

### 有料プランでの運用
- **容量監視**: ストレージ使用量の監視
- **パフォーマンス監視**: CPU時間とメモリ使用量
- **コスト管理**: 月額コストの予算管理

## 結論

### 現在の設計評価
- **無料プラン**: 小規模コミュニティ（200-300人）で運用可能
- **有料プラン**: 中規模コミュニティ（10,000-15,000人）で運用可能
- **制限要因**: 無料プランはKV書き込み、有料プランは長期的なストレージ容量

### 推奨運用方針
1. **無料プランでスタート**: 初期ユーザー獲得
2. **使用量監視**: 制限接近時の早期警告
3. **段階的スケールアップ**: 需要に応じた有料プラン移行
4. **長期戦略**: データアーカイブとストレージ最適化の検討