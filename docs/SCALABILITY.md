# スケーラビリティ分析

Discord 調整ちゃんの現在の設計における、Cloudflare の無料プランと有料プランでのスケーラビリティ分析。

## 2024年12月アップデート

### 主要な改善点
1. **D1 データベース採用**: 高スケーラビリティを実現
2. **Cloudflare Queues 導入**: 非同期処理による応答性改善
3. **Discord API 最適化**: レート制限への自然な対応

## 前提条件

### 典型的なユーザー行動パターン
- 新規スケジュール作成: 1回/user/日
- 投票操作: 2-3回/user/日 (参加・変更)
- 閲覧: 5-10回/user/日 (読み取り専用)

### D1操作の内訳
- スケジュール作成: 2-3回のDB書き込み（トランザクション使用）
- 投票操作: 1-2回のDB書き込み
- 閲覧: 1-2回のDB読み取り

## Cloudflare 無料プラン

### 制限事項
- **D1読み取り**: 5百万行/日
- **D1書き込み**: 100,000行/日
- **D1ストレージ**: 5GB
- **Worker実行**: 100,000回/日
- **Queues**: 100万メッセージ/月
- **メモリ**: 128MB
- **CPU時間**: 10ms/実行

### 推定容量

#### 日次容量
- **アクティブユーザー数**: 5,000-10,000人/日
- **新規スケジュール**: 1,000-2,000個/日
- **投票操作**: 10,000-20,000回/日
- **閲覧操作**: 50,000-100,000回/日

#### 制限要因
**D1書き込み制限（100,000行/日）**が主な制限
- スケジュール作成: 2,000個 × 10行 = 20,000行
- 投票操作: 20,000回 × 3行 = 60,000行
- **合計**: 80,000行/日 → **制限内で運用可能**

### 実際の運用可能範囲
- **安全マージン考慮**: 80,000行/日（制限の80%）
- **推定アクティブユーザー**: 5,000-8,000人/日
- **推定新規スケジュール**: 1,500個/日
- **推定投票操作**: 15,000回/日

## Cloudflare 有料プラン ($5/月)

### 制限事項
- **D1読み取り**: 50億行/月
- **D1書き込み**: 5000万行/月
- **D1ストレージ**: 10GB
- **Worker実行**: 10百万回/月
- **Queues**: 1000万メッセージ/月
- **メモリ**: 128MB
- **CPU時間**: 30秒/実行

### 推定容量

#### 日次容量
- **アクティブユーザー数**: 50,000-100,000人/日
- **新規スケジュール**: 10,000-20,000個/日
- **投票操作**: 100,000-300,000回/日
- **閲覧操作**: 500,000-1,000,000回/日

#### 制限要因

1. **Discord API制限**
   - Webhook制限: 30リクエスト/分
   - Cloudflare Queuesのバッチ処理で自然に対応
   - レート制限を意識せず大量処理可能

2. **D1ストレージ容量 (10GB)**
   - スケジュール1個あたり: 約1-2KB（正規化により効率化）
   - 推定保存可能数: 500万-1000万個
   - **6ヶ月自動削除により無限にスケール可能**

3. **Queuesメッセージ数**
   - メッセージ更新: 約200万/月（余裕あり）
   - 締切リマインダー: 約10万/月
   - **制限の20%程度で安全運用**

### 実際の運用能力

#### D1による大幅なスケーラビリティ向上
- **書き込み性能**: KVの100倍以上
- **読み取り性能**: SQLによる効率的なクエリ
- **トランザクション**: データ整合性の保証
- **インデックス**: 高速検索の実現

## Cloudflare Queues によるスケーラビリティ向上

### メッセージ更新の最適化

#### 従来の同期処理の問題
- 投票 → DB保存 → Discord API更新 = 310ms以上
- 複数同時投票でタイムアウトリスク
- API障害で投票自体が失敗

#### Queues導入後の改善
- 投票 → DB保存 → Queue送信 = 15ms（**20倍高速化**）
- 応答性の大幅向上により同時接続数の制限が事実上なくなる
- メッセージ更新の失敗が投票に影響しない

### データ整合性の確保

```typescript
// 同一メッセージへの複数更新を最適化
const latestUpdates = new Map<string, MessageUpdateTask>();
for (const task of tasks) {
  latestUpdates.set(key, task); // 最新のみ保持
}
```

**効果:**
- 100人が1秒で同時投票しても最新状態のみ反映
- 無駄なAPI呼び出しを削減
- Discord APIレート制限を自然に回避

### 締切処理のスケーラビリティ

#### バッチ処理による効率化
- 最大20件/バッチで処理
- Discord Search APIの制限（10req/10s）を考慮
- 1000件のリマインダーも安定処理可能

## 実際の運用での注意点

### 無料プランでの運用
- **監視必須**: D1書き込み行数の日次監視
- **制限対策**: 80%到達時のアラート設定
- **Queues活用**: 非同期処理で応答性確保

### 有料プランでの運用
- **容量監視**: D1ストレージ使用量（10GB制限）
- **Queue監視**: メッセージバックログサイズ
- **パフォーマンス**: SQLクエリの最適化
- **コスト管理**: 月額$5の固定費用

### スケーリング戦略

#### 垂直スケーリング
1. **無料 → 有料プラン**: 5,000人規模で移行検討
2. **インデックス最適化**: クエリパフォーマンス向上
3. **Queue設定調整**: バッチサイズとタイムアウト

#### 水平スケーリング
1. **リージョン分割**: 地域別にWorkers配置
2. **読み取り専用レプリカ**: D1 Read Replicasの活用
3. **CDN活用**: 静的アセットのキャッシュ

## 結論

### 現在の設計評価（D1 + Queues）
- **無料プラン**: 小〜中規模コミュニティ（5,000-10,000人/日）で運用可能
- **有料プラン**: 大規模コミュニティ（50,000-100,000人/日）で運用可能
- **制限要因**: 無料プランはD1書き込み制限、有料プランはDiscord API制限

### D1による性能特性
| 項目 | 性能 | 説明 |
|------|--------|--------|
| 無料プラン容量 | 5,000-10,000人/日 | D1の高い書き込み制限 |
| 有料プラン容量 | 50,000-100,000人/日 | 月間制限で大規模対応 |
| データ整合性 | ACID保証 | トランザクション対応 |
| クエリ性能 | SQLで効率化 | インデックスによる高速検索 |
| 応答時間 | 15ms | Queuesによる非同期化 |

### 推奨運用方針
1. **無料プランでスタート**: 5,000人規模まで十分対応
2. **Queues最適化**: バッチサイズとタイムアウトの調整
3. **監視とアラート**: D1使用量とQueue状態の監視
4. **段階的移行**: 
   - 5,000人超過 → 有料プラン検討
   - 50,000人超過 → アーキテクチャ再検討

### 今後の拡張性
- **D1 Read Replicas**: 読み取り性能のさらなる向上
- **Smart Placement**: 地理的に最適なWorker配置
- **Durable Objects**: 状態管理の高度化
- **R2統合**: 大容量データのアーカイブ